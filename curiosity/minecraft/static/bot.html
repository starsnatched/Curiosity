<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Bot - 3D View</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Berkeley+Mono:wght@400;500;600&family=Satoshi:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-void: #050508;
            --bg-deep: #0a0a10;
            --bg-panel: rgba(12, 12, 20, 0.95);
            --bg-card: rgba(18, 18, 28, 0.9);
            --bg-input: rgba(25, 25, 38, 0.8);
            --accent-emerald: #10b981;
            --accent-cyan: #06b6d4;
            --accent-violet: #8b5cf6;
            --accent-rose: #f43f5e;
            --accent-amber: #f59e0b;
            --text-bright: #f8fafc;
            --text-mid: #94a3b8;
            --text-dim: #475569;
            --border-subtle: rgba(148, 163, 184, 0.1);
            --border-glow: rgba(16, 185, 129, 0.3);
            --glow-emerald: 0 0 40px rgba(16, 185, 129, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @font-face {
            font-family: 'Berkeley Mono';
            src: local('Berkeley Mono'), local('SF Mono'), local('Monaco');
        }

        body {
            font-family: 'Satoshi', system-ui, sans-serif;
            background: var(--bg-void);
            color: var(--text-bright);
            min-height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr 340px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 1px;
            background: var(--border-subtle);
        }

        header {
            grid-column: 1 / -1;
            background: var(--bg-panel);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .brand-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-emerald), var(--accent-cyan));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: var(--glow-emerald);
        }

        .brand h1 {
            font-size: 1.15rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .status-group {
            display: flex;
            gap: 12px;
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            font-size: 0.82rem;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-dim);
            transition: all 0.3s;
        }

        .status-dot.live {
            background: var(--accent-emerald);
            box-shadow: 0 0 12px var(--accent-emerald);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.9); }
        }

        .main-view {
            background: var(--bg-deep);
            position: relative;
            overflow: hidden;
        }

        #render-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .render-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(5, 5, 8, 0.9);
            backdrop-filter: blur(8px);
            transition: opacity 0.3s, visibility 0.3s;
        }

        .render-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .overlay-content {
            text-align: center;
        }

        .overlay-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .overlay-text {
            font-size: 0.95rem;
            color: var(--text-mid);
        }

        .hud-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .hud-compass {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 40px;
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            overflow: hidden;
        }

        .compass-strip {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            white-space: nowrap;
            font-family: 'Berkeley Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-mid);
            transition: left 0.1s linear;
        }

        .compass-marker {
            display: inline-block;
            width: 50px;
            text-align: center;
        }

        .compass-marker.cardinal {
            color: var(--accent-emerald);
            font-weight: 600;
        }

        .compass-center {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 100%;
            background: var(--accent-emerald);
            box-shadow: 0 0 8px var(--accent-emerald);
        }

        .hud-coords {
            position: absolute;
            bottom: 20px;
            left: 20px;
            padding: 12px 16px;
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            font-family: 'Berkeley Mono', monospace;
            font-size: 0.85rem;
        }

        .coord-row {
            display: flex;
            gap: 20px;
        }

        .coord-label {
            color: var(--text-dim);
            width: 16px;
        }

        .coord-value {
            color: var(--accent-cyan);
            min-width: 60px;
        }

        .hud-crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
        }

        .crosshair-h, .crosshair-v {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
        }

        .crosshair-h {
            width: 100%;
            height: 2px;
            top: 50%;
            transform: translateY(-50%);
        }

        .crosshair-v {
            width: 2px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        .hud-fps {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 12px;
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            font-family: 'Berkeley Mono', monospace;
            font-size: 0.8rem;
            color: var(--accent-emerald);
        }

        .sidebar {
            background: var(--bg-panel);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel {
            border-bottom: 1px solid var(--border-subtle);
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-mid);
        }

        .panel-icon {
            opacity: 0.7;
        }

        .panel-body {
            padding: 16px;
        }

        .connection-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group.full {
            grid-column: 1 / -1;
        }

        .input-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .input-field {
            padding: 10px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-bright);
            font-family: 'Berkeley Mono', monospace;
            font-size: 0.85rem;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-emerald);
        }

        .btn-row {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 11px 16px;
            border: none;
            border-radius: 8px;
            font-family: 'Satoshi', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-emerald), #059669);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: var(--accent-rose);
            color: white;
        }

        .btn-danger:hover {
            background: #e11d48;
        }

        .vitals-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .vital-card {
            padding: 14px;
            background: var(--bg-input);
            border-radius: 10px;
            text-align: center;
        }

        .vital-value {
            font-family: 'Berkeley Mono', monospace;
            font-size: 1.6rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-violet));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .vital-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .bar-group {
            margin-bottom: 14px;
        }

        .bar-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.78rem;
            margin-bottom: 6px;
        }

        .bar-label {
            color: var(--text-mid);
        }

        .bar-value {
            font-family: 'Berkeley Mono', monospace;
            color: var(--text-bright);
        }

        .bar-track {
            height: 8px;
            background: var(--bg-input);
            border-radius: 4px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .bar-fill.health {
            background: linear-gradient(90deg, var(--accent-rose), #fb7185);
        }

        .bar-fill.food {
            background: linear-gradient(90deg, var(--accent-amber), #fbbf24);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .control-key {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 14px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            user-select: none;
        }

        .control-key:hover {
            background: rgba(148, 163, 184, 0.1);
        }

        .control-key.active {
            background: var(--accent-emerald);
            border-color: var(--accent-emerald);
            box-shadow: 0 0 16px rgba(16, 185, 129, 0.4);
        }

        .control-key.active .key-char {
            color: var(--bg-void);
        }

        .control-key.active .key-label {
            color: rgba(0, 0, 0, 0.6);
        }

        .key-char {
            font-family: 'Berkeley Mono', monospace;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-bright);
        }

        .key-label {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 3px;
        }

        .log-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .log-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            font-family: 'Berkeley Mono', monospace;
            font-size: 0.75rem;
            line-height: 1.6;
        }

        .log-entry {
            padding: 4px 0;
            color: var(--text-dim);
            border-bottom: 1px solid rgba(148, 163, 184, 0.05);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.info { color: var(--accent-cyan); }
        .log-entry.success { color: var(--accent-emerald); }
        .log-entry.error { color: var(--accent-rose); }
        .log-entry.event { color: var(--accent-violet); }

        .minimap {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 180px;
            height: 180px;
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            overflow: hidden;
        }

        #minimap-canvas {
            width: 100%;
            height: 100%;
        }

        .pointer-lock-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 16px 24px;
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            font-size: 0.9rem;
            color: var(--text-mid);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .pointer-lock-hint.visible {
            opacity: 1;
        }

        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr auto;
            }

            .sidebar {
                max-height: 40vh;
                overflow-y: auto;
            }

            .minimap {
                width: 120px;
                height: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="brand">
                <div class="brand-icon">‚õèÔ∏è</div>
                <h1>Minecraft Bot</h1>
            </div>
            <div class="status-group">
                <div class="status-pill">
                    <div class="status-dot" id="ws-dot"></div>
                    <span id="ws-text">Connecting...</span>
                </div>
                <div class="status-pill">
                    <div class="status-dot" id="bot-dot"></div>
                    <span id="bot-text">Offline</span>
                </div>
            </div>
        </header>

        <div class="main-view" id="main-view">
            <canvas id="render-canvas"></canvas>
            <div class="render-overlay" id="render-overlay">
                <div class="overlay-content">
                    <div class="overlay-icon">üåç</div>
                    <div class="overlay-text">Connect to a Minecraft server to begin</div>
                    </div>
                        </div>
            <div class="hud-layer" id="hud-layer">
                <div class="hud-compass">
                    <div class="compass-strip" id="compass-strip">
                        <span class="compass-marker">W</span>
                        <span class="compass-marker cardinal">N</span>
                        <span class="compass-marker">E</span>
                        <span class="compass-marker cardinal">S</span>
                        <span class="compass-marker">W</span>
                        <span class="compass-marker cardinal">N</span>
                        <span class="compass-marker">E</span>
                        <span class="compass-marker cardinal">S</span>
                        <span class="compass-marker">W</span>
                        </div>
                    <div class="compass-center"></div>
                        </div>
                <div class="hud-coords">
                    <div class="coord-row">
                        <span class="coord-label">X</span>
                        <span class="coord-value" id="coord-x">0.0</span>
                        <span class="coord-label">Y</span>
                        <span class="coord-value" id="coord-y">0.0</span>
                        <span class="coord-label">Z</span>
                        <span class="coord-value" id="coord-z">0.0</span>
                    </div>
                    </div>
                <div class="hud-crosshair">
                    <div class="crosshair-h"></div>
                    <div class="crosshair-v"></div>
                </div>
                <div class="hud-fps" id="hud-fps">-- FPS</div>
                <div class="minimap">
                    <canvas id="minimap-canvas"></canvas>
                    </div>
                            </div>
            <div class="pointer-lock-hint" id="pointer-hint">Click to control camera</div>
                            </div>

        <div class="sidebar">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-icon">üîå</span>
                    <span>Connection</span>
                            </div>
                <div class="panel-body">
                    <div class="connection-grid">
                        <div class="input-group">
                            <label class="input-label">Host</label>
                            <input type="text" class="input-field" id="mc-host" value="localhost">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Port</label>
                            <input type="number" class="input-field" id="mc-port" value="25565">
                    </div>
                        <div class="input-group full">
                            <label class="input-label">Username</label>
                            <input type="text" class="input-field" id="mc-username" value="PythonBot">
                </div>
                    </div>
                    <div class="btn-row">
                        <button class="btn btn-primary" id="btn-connect" onclick="connectBot()">Connect</button>
                        <button class="btn btn-danger" id="btn-disconnect" onclick="disconnectBot()">Disconnect</button>
                        </div>
                        </div>
                        </div>

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-icon">‚ù§Ô∏è</span>
                    <span>Status</span>
                        </div>
                <div class="panel-body">
                    <div class="bar-group">
                        <div class="bar-header">
                            <span class="bar-label">Health</span>
                            <span class="bar-value" id="health-val">20/20</span>
                        </div>
                        <div class="bar-track">
                            <div class="bar-fill health" id="health-bar" style="width: 100%"></div>
                        </div>
                        </div>
                    <div class="bar-group">
                        <div class="bar-header">
                            <span class="bar-label">Hunger</span>
                            <span class="bar-value" id="food-val">20/20</span>
                        </div>
                        <div class="bar-track">
                            <div class="bar-fill food" id="food-bar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="vitals-grid">
                        <div class="vital-card">
                            <div class="vital-value" id="chunks-val">0</div>
                            <div class="vital-label">Chunks</div>
                </div>
                        <div class="vital-card">
                            <div class="vital-value" id="entities-val">0</div>
                            <div class="vital-label">Entities</div>
            </div>
                    </div>
                        </div>
                        </div>

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-icon">‚å®Ô∏è</span>
                    <span>Controls</span>
                    </div>
                <div class="panel-body">
                    <div class="controls-grid">
                        <div class="control-key" id="key-q">
                            <span class="key-char">Q</span>
                            <span class="key-label">Drop</span>
                        </div>
                        <div class="control-key" id="key-w">
                            <span class="key-char">W</span>
                            <span class="key-label">Forward</span>
                        </div>
                        <div class="control-key" id="key-e">
                            <span class="key-char">E</span>
                            <span class="key-label">Use</span>
                    </div>
                        <div class="control-key" id="key-a">
                            <span class="key-char">A</span>
                            <span class="key-label">Left</span>
                        </div>
                        <div class="control-key" id="key-s">
                            <span class="key-char">S</span>
                            <span class="key-label">Back</span>
                        </div>
                        <div class="control-key" id="key-d">
                            <span class="key-char">D</span>
                            <span class="key-label">Right</span>
                        </div>
                        <div class="control-key" id="key-shift">
                            <span class="key-char">‚áß</span>
                            <span class="key-label">Sneak</span>
                        </div>
                        <div class="control-key" id="key-space">
                            <span class="key-char">‚ê£</span>
                            <span class="key-label">Jump</span>
                    </div>
                        <div class="control-key" id="key-ctrl">
                            <span class="key-char">‚åÉ</span>
                            <span class="key-label">Sprint</span>
                </div>
                    </div>
                    </div>
                </div>

            <div class="panel log-panel">
                <div class="panel-header">
                    <span class="panel-icon">üìã</span>
                    <span>Log</span>
                    </div>
                <div class="log-scroll" id="log-scroll">
                        <div class="log-entry info">Ready to connect...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WS_URL = `ws://${window.location.host}/ws`;
        let ws = null;
        let state = null;
        let canvas, gl, minimapCanvas, minimapCtx;
        let pressedKeys = new Set();
        let pointerLocked = false;
        let frameCount = 0;
        let lastFpsTime = performance.now();

        let camera = { yaw: 0, pitch: 0 };
        let worldData = { chunks: [], entities: [], playerPos: { x: 0, y: 64, z: 0 } };

        let shaderProgram, posBuffer, colorBuffer;
        let projMatrix, viewMatrix, modelMatrix;

        function init() {
            canvas = document.getElementById('render-canvas');
            minimapCanvas = document.getElementById('minimap-canvas');
            minimapCtx = minimapCanvas.getContext('2d');

            initWebGL();
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            document.addEventListener('mousemove', onMouseMove);

            const mainView = document.getElementById('main-view');
            mainView.addEventListener('click', () => {
                if (!pointerLocked) {
                    canvas.requestPointerLock();
                }
            });

            document.addEventListener('pointerlockchange', () => {
                pointerLocked = document.pointerLockElement === canvas;
                document.getElementById('pointer-hint').classList.toggle('visible', !pointerLocked && state?.connected);
            });

            connectWebSocket();
            requestAnimationFrame(render);
        }

        function initWebGL() {
            gl = canvas.getContext('webgl2') || canvas.getContext('webgl');
            if (!gl) {
                console.error('WebGL not supported');
                return;
            }

            const vsSource = `
                attribute vec4 aPosition;
                attribute vec4 aColor;
                uniform mat4 uProjection;
                uniform mat4 uView;
                uniform mat4 uModel;
                varying lowp vec4 vColor;
                void main() {
                    gl_Position = uProjection * uView * uModel * aPosition;
                    vColor = aColor;
                }
            `;

            const fsSource = `
                precision mediump float;
                varying lowp vec4 vColor;
                uniform float uFog;
                void main() {
                    float depth = gl_FragCoord.z / gl_FragCoord.w;
                    float fogFactor = 1.0 - clamp(depth * uFog, 0.0, 0.8);
                    vec3 fogColor = vec3(0.02, 0.02, 0.03);
                    gl_FragColor = vec4(mix(fogColor, vColor.rgb, fogFactor), vColor.a);
                }
            `;

            const vs = compileShader(gl.VERTEX_SHADER, vsSource);
            const fs = compileShader(gl.FRAGMENT_SHADER, fsSource);

            shaderProgram = gl.createProgram();
            gl.attachShader(shaderProgram, vs);
            gl.attachShader(shaderProgram, fs);
            gl.linkProgram(shaderProgram);

            if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
                console.error('Shader link failed:', gl.getProgramInfoLog(shaderProgram));
            }

            gl.useProgram(shaderProgram);
            gl.enable(gl.DEPTH_TEST);
            gl.enable(gl.CULL_FACE);
            gl.cullFace(gl.BACK);
        }

        function compileShader(type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                console.error('Shader compile error:', gl.getShaderInfoLog(shader));
            }
            return shader;
        }

        function resizeCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width * window.devicePixelRatio;
            canvas.height = rect.height * window.devicePixelRatio;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';

            minimapCanvas.width = 180;
            minimapCanvas.height = 180;

            if (gl) {
                gl.viewport(0, 0, canvas.width, canvas.height);
            }
        }

        function createMatrix4() {
            return new Float32Array([
                1, 0, 0, 0,
                0, 1, 0, 0,
                0, 0, 1, 0,
                0, 0, 0, 1
            ]);
        }

        function perspective(fov, aspect, near, far) {
            const f = 1.0 / Math.tan(fov / 2);
            const nf = 1 / (near - far);
            return new Float32Array([
                f / aspect, 0, 0, 0,
                0, f, 0, 0,
                0, 0, (far + near) * nf, -1,
                0, 0, 2 * far * near * nf, 0
            ]);
        }

        function lookAt(eye, center, up) {
            const z = normalize([eye[0] - center[0], eye[1] - center[1], eye[2] - center[2]]);
            const x = normalize(cross(up, z));
            const y = cross(z, x);

            return new Float32Array([
                x[0], y[0], z[0], 0,
                x[1], y[1], z[1], 0,
                x[2], y[2], z[2], 0,
                -dot(x, eye), -dot(y, eye), -dot(z, eye), 1
            ]);
        }

        function normalize(v) {
            const len = Math.sqrt(v[0]*v[0] + v[1]*v[1] + v[2]*v[2]);
            return [v[0]/len, v[1]/len, v[2]/len];
        }

        function cross(a, b) {
            return [
                a[1]*b[2] - a[2]*b[1],
                a[2]*b[0] - a[0]*b[2],
                a[0]*b[1] - a[1]*b[0]
            ];
        }

        function dot(a, b) {
            return a[0]*b[0] + a[1]*b[1] + a[2]*b[2];
        }

        function translate(m, v) {
            const out = new Float32Array(m);
            out[12] = m[0]*v[0] + m[4]*v[1] + m[8]*v[2] + m[12];
            out[13] = m[1]*v[0] + m[5]*v[1] + m[9]*v[2] + m[13];
            out[14] = m[2]*v[0] + m[6]*v[1] + m[10]*v[2] + m[14];
            return out;
        }

        function render() {
            if (!gl) {
                requestAnimationFrame(render);
                return;
            }

            frameCount++;
            const now = performance.now();
            if (now - lastFpsTime >= 1000) {
                document.getElementById('hud-fps').textContent = `${frameCount} FPS`;
                frameCount = 0;
                lastFpsTime = now;
            }

            gl.clearColor(0.02, 0.02, 0.03, 1.0);
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

            if (state?.connected) {
                renderWorld();
                renderMinimap();
            }

            requestAnimationFrame(render);
        }

        function renderWorld() {
            const aspect = canvas.width / canvas.height;
            projMatrix = perspective(Math.PI / 3, aspect, 0.1, 1000);

            const pos = worldData.playerPos;
            const yawRad = camera.yaw * Math.PI / 180;
            const pitchRad = camera.pitch * Math.PI / 180;

            const eyeHeight = 1.62;
            const eye = [pos.x, pos.y + eyeHeight, pos.z];
            const lookDir = [
                -Math.sin(yawRad) * Math.cos(pitchRad),
                Math.sin(pitchRad),
                Math.cos(yawRad) * Math.cos(pitchRad)
            ];
            const center = [eye[0] + lookDir[0], eye[1] + lookDir[1], eye[2] + lookDir[2]];
            viewMatrix = lookAt(eye, center, [0, 1, 0]);

            const projLoc = gl.getUniformLocation(shaderProgram, 'uProjection');
            const viewLoc = gl.getUniformLocation(shaderProgram, 'uView');
            const modelLoc = gl.getUniformLocation(shaderProgram, 'uModel');
            const fogLoc = gl.getUniformLocation(shaderProgram, 'uFog');

            gl.uniformMatrix4fv(projLoc, false, projMatrix);
            gl.uniformMatrix4fv(viewLoc, false, viewMatrix);
            gl.uniform1f(fogLoc, 0.02);

            renderGround(modelLoc);
            renderChunkOutlines(modelLoc);
            renderEntities(modelLoc);
            renderGridFloor(modelLoc);
        }

        function renderGround(modelLoc) {
            const groundSize = 200;
            const y = -0.01;
            const vertices = new Float32Array([
                -groundSize, y, -groundSize,
                 groundSize, y, -groundSize,
                 groundSize, y,  groundSize,
                -groundSize, y, -groundSize,
                 groundSize, y,  groundSize,
                -groundSize, y,  groundSize,
            ]);

            const colors = new Float32Array([
                0.08, 0.12, 0.08, 1,
                0.08, 0.12, 0.08, 1,
                0.06, 0.10, 0.06, 1,
                0.08, 0.12, 0.08, 1,
                0.06, 0.10, 0.06, 1,
                0.06, 0.10, 0.06, 1,
            ]);

            drawMesh(vertices, colors, modelLoc, createMatrix4());
        }

        function renderGridFloor(modelLoc) {
            const gridSize = 100;
            const spacing = 16;
            const vertices = [];
            const colors = [];
            const y = 0;

            for (let x = -gridSize; x <= gridSize; x += spacing) {
                vertices.push(x, y, -gridSize, x, y, gridSize);
                colors.push(0.1, 0.15, 0.1, 0.5, 0.1, 0.15, 0.1, 0.5);
            }
            for (let z = -gridSize; z <= gridSize; z += spacing) {
                vertices.push(-gridSize, y, z, gridSize, y, z);
                colors.push(0.1, 0.15, 0.1, 0.5, 0.1, 0.15, 0.1, 0.5);
            }

            if (vertices.length > 0) {
                drawLines(new Float32Array(vertices), new Float32Array(colors), modelLoc, createMatrix4());
            }
        }

        function renderChunkOutlines(modelLoc) {
            const chunks = worldData.chunks || [];
            const chunkHeight = 16;
            const y = 64;

            chunks.forEach(chunk => {
                const cx = chunk.x * 16;
                const cz = chunk.z * 16;

                const vertices = new Float32Array([
                    cx, y, cz,
                    cx + 16, y, cz,
                    cx + 16, y, cz,
                    cx + 16, y, cz + 16,
                    cx + 16, y, cz + 16,
                    cx, y, cz + 16,
                    cx, y, cz + 16,
                    cx, y, cz,
                ]);

                const colors = new Float32Array([
                    0.2, 0.8, 0.4, 0.6,
                    0.2, 0.8, 0.4, 0.6,
                    0.2, 0.8, 0.4, 0.6,
                    0.2, 0.8, 0.4, 0.6,
                    0.2, 0.8, 0.4, 0.6,
                    0.2, 0.8, 0.4, 0.6,
                    0.2, 0.8, 0.4, 0.6,
                    0.2, 0.8, 0.4, 0.6,
                ]);

                drawLines(vertices, colors, modelLoc, createMatrix4());
            });
        }

        function renderEntities(modelLoc) {
            const entities = worldData.entities || [];

            entities.forEach(entity => {
                const size = 0.5;
                const x = entity.x;
                const y = entity.y;
                const z = entity.z;

                const vertices = new Float32Array([
                    x-size, y, z-size,  x+size, y, z-size,  x+size, y+size*2, z-size,
                    x-size, y, z-size,  x+size, y+size*2, z-size,  x-size, y+size*2, z-size,

                    x+size, y, z-size,  x+size, y, z+size,  x+size, y+size*2, z+size,
                    x+size, y, z-size,  x+size, y+size*2, z+size,  x+size, y+size*2, z-size,

                    x+size, y, z+size,  x-size, y, z+size,  x-size, y+size*2, z+size,
                    x+size, y, z+size,  x-size, y+size*2, z+size,  x+size, y+size*2, z+size,

                    x-size, y, z+size,  x-size, y, z-size,  x-size, y+size*2, z-size,
                    x-size, y, z+size,  x-size, y+size*2, z-size,  x-size, y+size*2, z+size,

                    x-size, y+size*2, z-size,  x+size, y+size*2, z-size,  x+size, y+size*2, z+size,
                    x-size, y+size*2, z-size,  x+size, y+size*2, z+size,  x-size, y+size*2, z+size,
                ]);

                const r = 0.5 + (entity.type % 3) * 0.2;
                const g = 0.3 + (entity.type % 5) * 0.1;
                const b = 0.8;

                const colors = [];
                for (let i = 0; i < 30; i++) {
                    colors.push(r, g, b, 1);
                }

                drawMesh(vertices, new Float32Array(colors), modelLoc, createMatrix4());
            });
        }

        function drawMesh(vertices, colors, modelLoc, modelMatrix) {
            const posBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, posBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);

            const posLoc = gl.getAttribLocation(shaderProgram, 'aPosition');
            gl.enableVertexAttribArray(posLoc);
            gl.vertexAttribPointer(posLoc, 3, gl.FLOAT, false, 0, 0);

            const colorBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, colors, gl.STATIC_DRAW);

            const colorLoc = gl.getAttribLocation(shaderProgram, 'aColor');
            gl.enableVertexAttribArray(colorLoc);
            gl.vertexAttribPointer(colorLoc, 4, gl.FLOAT, false, 0, 0);

            gl.uniformMatrix4fv(modelLoc, false, modelMatrix);
            gl.drawArrays(gl.TRIANGLES, 0, vertices.length / 3);

            gl.deleteBuffer(posBuffer);
            gl.deleteBuffer(colorBuffer);
        }

        function drawLines(vertices, colors, modelLoc, modelMatrix) {
            const posBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, posBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);

            const posLoc = gl.getAttribLocation(shaderProgram, 'aPosition');
            gl.enableVertexAttribArray(posLoc);
            gl.vertexAttribPointer(posLoc, 3, gl.FLOAT, false, 0, 0);

            const colorBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, colors, gl.STATIC_DRAW);

            const colorLoc = gl.getAttribLocation(shaderProgram, 'aColor');
            gl.enableVertexAttribArray(colorLoc);
            gl.vertexAttribPointer(colorLoc, 4, gl.FLOAT, false, 0, 0);

            gl.uniformMatrix4fv(modelLoc, false, modelMatrix);
            gl.drawArrays(gl.LINES, 0, vertices.length / 3);

            gl.deleteBuffer(posBuffer);
            gl.deleteBuffer(colorBuffer);
        }

        function renderMinimap() {
            const ctx = minimapCtx;
            const w = minimapCanvas.width;
            const h = minimapCanvas.height;
            const scale = 2;

            ctx.fillStyle = 'rgba(10, 10, 16, 0.9)';
            ctx.fillRect(0, 0, w, h);

            const cx = w / 2;
            const cy = h / 2;
            const pos = worldData.playerPos;

            ctx.strokeStyle = 'rgba(16, 185, 129, 0.3)';
            ctx.lineWidth = 1;

            const chunks = worldData.chunks || [];
            chunks.forEach(chunk => {
                const dx = (chunk.x * 16 + 8 - pos.x) * scale;
                const dz = (chunk.z * 16 + 8 - pos.z) * scale;

                if (Math.abs(dx) < w/2 && Math.abs(dz) < h/2) {
                    ctx.strokeRect(cx + dx - 8*scale, cy + dz - 8*scale, 16*scale, 16*scale);
                }
            });

            const entities = worldData.entities || [];
            ctx.fillStyle = 'rgba(139, 92, 246, 0.8)';
            entities.forEach(e => {
                const dx = (e.x - pos.x) * scale;
                const dz = (e.z - pos.z) * scale;

                if (Math.abs(dx) < w/2 && Math.abs(dz) < h/2) {
                ctx.beginPath();
                    ctx.arc(cx + dx, cy + dz, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            });

            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(camera.yaw * Math.PI / 180);

            ctx.fillStyle = '#10b981';
            ctx.beginPath();
            ctx.moveTo(0, -8);
            ctx.lineTo(-5, 6);
            ctx.lineTo(5, 6);
            ctx.closePath();
            ctx.fill();

            ctx.restore();
        }

        function updateCompass() {
            const yaw = camera.yaw % 360;
            const offset = -(yaw / 360) * 400 + 100;
            document.getElementById('compass-strip').style.left = offset + 'px';
        }

        function connectWebSocket() {
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                updateStatus('ws', true, 'Connected');
                addLog('WebSocket connected', 'success');
            };

            ws.onclose = () => {
                updateStatus('ws', false, 'Disconnected');
                addLog('WebSocket disconnected', 'error');
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = () => {
                updateStatus('ws', false, 'Error');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'state') {
                    state = data.data;
                    updateUI();
                } else if (data.type === 'event') {
                    handleEvent(data);
                } else if (data.type === 'ack') {
                    if (!data.success) {
                        addLog(`Action failed: ${data.action}`, 'error');
                    }
                } else if (data.type === 'error') {
                    addLog(`Error: ${data.error}`, 'error');
                }
            };
        }

        function updateStatus(type, online, text) {
            document.getElementById(`${type}-dot`).classList.toggle('live', online);
            document.getElementById(`${type}-text`).textContent = text;
        }

        function updateUI() {
            if (!state) return;

            const connected = state.connected;
            updateStatus('bot', connected, connected ? 'Online' : 'Offline');
            document.getElementById('render-overlay').classList.toggle('hidden', connected);
            document.getElementById('hud-layer').style.display = connected ? 'block' : 'none';

            if (state.player?.position) {
                const pos = state.player.position;
                worldData.playerPos = { x: pos.x, y: pos.y, z: pos.z };
                camera.yaw = pos.yaw || 0;
                camera.pitch = -(pos.pitch || 0);

                document.getElementById('coord-x').textContent = pos.x.toFixed(1);
                document.getElementById('coord-y').textContent = pos.y.toFixed(1);
                document.getElementById('coord-z').textContent = pos.z.toFixed(1);

                updateCompass();
            }

            const health = state.player?.health || 0;
            const food = state.player?.food || 0;
            document.getElementById('health-val').textContent = `${Math.floor(health)}/20`;
            document.getElementById('health-bar').style.width = `${(health/20)*100}%`;
            document.getElementById('food-val').textContent = `${food}/20`;
            document.getElementById('food-bar').style.width = `${(food/20)*100}%`;

            document.getElementById('chunks-val').textContent = state.world?.loaded_chunks_count || 0;
            document.getElementById('entities-val').textContent = state.world?.entities_count || 0;

            worldData.chunks = state.world?.visible_chunks || [];
            worldData.entities = state.entities || [];

            ['w', 'a', 's', 'd'].forEach(k => {
                document.getElementById(`key-${k}`).classList.toggle('active', state.movement_keys?.includes(k));
            });
            document.getElementById('key-shift').classList.toggle('active', state.is_sneaking);
            document.getElementById('key-ctrl').classList.toggle('active', state.is_sprinting);
        }

        function handleEvent(data) {
            const event = data.event;
            if (event === 'join') {
                addLog(`Joined game as ${data.player}`, 'success');
            } else if (event === 'spawn') {
                const p = data.position;
                addLog(`Spawned at ${p.x.toFixed(1)}, ${p.y.toFixed(1)}, ${p.z.toFixed(1)}`, 'event');
            } else if (event === 'health') {
                addLog(`Health: ${data.health.toFixed(1)}, Food: ${data.food}`, 'info');
            } else if (event === 'death') {
                addLog('Player died!', 'error');
            } else if (event === 'disconnect') {
                addLog('Disconnected from server', 'error');
            }
        }

        function onKeyDown(e) {
            if (document.activeElement.tagName === 'INPUT') return;
            
            const keyActions = {
                'w': 'move_forward',
                'a': 'move_left',
                's': 'move_backward',
                'd': 'move_right',
                ' ': 'jump',
                'Shift': 'sneak',
                'Control': 'sprint',
            };

            const action = keyActions[e.key];
            if (action && !pressedKeys.has(e.key)) {
                pressedKeys.add(e.key);
                e.preventDefault();
                
                if (action === 'jump') {
                    sendInput({ action: 'jump' });
                } else {
                    sendInput({ action, start: true });
                }
            }
        }

        function onKeyUp(e) {
            const keyActions = {
                'w': 'move_forward',
                'a': 'move_left',
                's': 'move_backward',
                'd': 'move_right',
                'Shift': 'sneak',
                'Control': 'sprint',
            };

            const action = keyActions[e.key];
            if (action && pressedKeys.has(e.key)) {
                pressedKeys.delete(e.key);
                e.preventDefault();
                
                if (action !== 'jump') {
                    sendInput({ action, start: false });
                }
            }
        }

        function onMouseMove(e) {
            if (!pointerLocked || !state?.connected) return;

            const sensitivity = 0.15;
            const yawDelta = e.movementX * sensitivity;
            const pitchDelta = -e.movementY * sensitivity;

            sendInput({ action: 'look_relative', yaw_delta: yawDelta, pitch_delta: pitchDelta });
        }

        function sendInput(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(data));
            }
        }

        function connectBot() {
            const host = document.getElementById('mc-host').value;
            const port = parseInt(document.getElementById('mc-port').value);
            const username = document.getElementById('mc-username').value;
            
            addLog(`Connecting to ${host}:${port} as ${username}...`, 'info');
            sendInput({ action: 'connect', host, port, username });
        }

        function disconnectBot() {
            addLog('Disconnecting...', 'info');
            sendInput({ action: 'disconnect' });
        }

        function addLog(message, type = 'info') {
            const container = document.getElementById('log-scroll');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            entry.textContent = `[${time}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
            
            while (container.children.length > 100) {
                container.removeChild(container.firstChild);
            }
        }

        init();
    </script>
</body>
</html>
